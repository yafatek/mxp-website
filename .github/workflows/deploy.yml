name: Deploy Website to CloudFront

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: '20'
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  deploy:
    name: Build and Deploy to AWS
    runs-on: ubuntu-latest
    environment: main
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: ğŸ“¥ Install dependencies
        run: |
          echo "Installing dependencies with yarn..."
          yarn install --frozen-lockfile --prefer-offline
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ”¨ Build website
        run: |
          echo "Building production website..."
          yarn build
          echo "âœ… Build completed successfully"
        env:
          NODE_ENV: production

      - name: ğŸ“Š Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Error: dist directory not found after build"
            exit 1
          fi
          echo "ğŸ“ Build output:"
          ls -lah dist/ | head -20
          echo "âœ… Build verification passed"

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-Deploy-Website

      - name: â˜ï¸ Upload assets to S3
        run: |
          echo "Uploading static assets to S3..."
          aws s3 sync dist/ s3://${{ vars.S3_BUCKET_NAME }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "*.json" \
            --exclude "*.xml" \
            --exclude "*.txt" \
            --exclude "service-worker.js" \
            --exclude "manifest.json"
          
          echo "âœ… Static assets uploaded"

      - name: ğŸ“„ Upload HTML and JSON files
        run: |
          echo "Uploading HTML and JSON files..."
          aws s3 sync dist/ s3://${{ vars.S3_BUCKET_NAME }} \
            --delete \
            --cache-control "public, max-age=0, must-revalidate" \
            --include "*.html" \
            --include "*.json" \
            --include "*.xml" \
            --include "*.txt" \
            --include "service-worker.js" \
            --include "manifest.json"
          
          echo "âœ… HTML and JSON files uploaded"

      - name: ğŸ—‘ï¸ Invalidate CloudFront cache
        run: |
          echo "Creating CloudFront invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "Invalidation ID: $INVALIDATION_ID"
          echo "Waiting for invalidation to complete..."
          
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} \
            --id $INVALIDATION_ID
          
          echo "âœ… CloudFront cache invalidated"

      - name: âœ… Deployment summary
        run: |
          echo "## ğŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŒ Website URL | https://${{ vars.DOMAIN_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ S3 Bucket | ${{ vars.S3_BUCKET_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â˜ï¸ CloudFront ID | ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ Region | ${{ vars.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”„ Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Website deployed successfully!"
          echo "ğŸŒ URL: https://${{ vars.DOMAIN_NAME }}"
          echo "ğŸ“¦ S3 Bucket: ${{ vars.S3_BUCKET_NAME }}"
          echo "â˜ï¸  CloudFront: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}"
          echo "ğŸ”„ Commit: ${{ github.sha }}"

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "Cleaning up temporary files..."
          rm -rf node_modules dist
          echo "âœ… Cleanup completed"
